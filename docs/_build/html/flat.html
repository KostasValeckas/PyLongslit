<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Flat-field &#8212; PyLongslit  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reduction of observations" href="reduce.html" />
    <link rel="prev" title="Wavelength Calibration" href="wavecalib.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="flat-field">
<span id="flat"></span><h1>Flat-field<a class="headerlink" href="#flat-field" title="Link to this heading">¶</a></h1>
<section id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Link to this heading">¶</a></h2>
<p>The command for running the flat-field procedure is called by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pylongslit_flat<span class="w"> </span>PATH_TO_CONFIG_FILE
</pre></div>
</div>
<p>The flat-field procedure produces a master flat-field frame <code class="docutils literal notranslate"><span class="pre">master_flat.fits</span></code>,
and places it in the  output directory specified in the configuration file. The master
flat is a median-combined, spectrally, and (optionally) spatially normalized flat-field frame.
It holds the information about the pixel-to-pixel sensitivity of the detector, where
pixel value 1.0 is the mean pixel intensity for the detector</p>
<p>The flat-field procedure has several stages - all described individually below
in this documentation. The stages are:</p>
<ol class="arabic simple">
<li><p>Median combination of the raw flat frames.</p></li>
<li><p>Spectral normalization of the master flat.</p></li>
<li><p>(Optional) Spatial normalization of the master flat.</p></li>
</ol>
<p>The raw flat frames are read from the directory specified in the configuration file
under the parameter <code class="docutils literal notranslate"><span class="pre">&quot;flat_dir&quot;</span></code>. Make sure that no other file types are present in the
directory.</p>
</section>
<section id="median-combination-of-the-raw-flat-frames">
<h2>Median combination of the raw flat frames<a class="headerlink" href="#median-combination-of-the-raw-flat-frames" title="Link to this heading">¶</a></h2>
<p>The raw flat frames get median combined the same way as described in the
<a class="reference internal" href="bias.html#bias"><span class="std std-ref">bias procedure</span></a>. The difference is that the flat frames are
firstly bias-subtracted and if the detector has a significant <a class="reference internal" href="dark_current.html#dark"><span class="std std-ref">dark current</span></a>,
the dark current can also be removed. Similar to the <a class="reference internal" href="bias.html#bias"><span class="std std-ref">bias procedure</span></a>,
the user can decide whether bootstrapping is necessary for the error estimation
of the median by setting the parameter <code class="docutils literal notranslate"><span class="pre">&quot;bootstrap_errors&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>
or <code class="docutils literal notranslate"><span class="pre">false</span></code> in the configuration file. To see full descrition of the
error estimation in the software, please refer to the <a class="reference internal" href="uncertainties.html#uncertainties"><span class="std std-ref">description of uncertainty calculations</span></a>.</p>
</section>
<section id="spectral-normalization-of-the-master-flat">
<h2>Spectral normalization of the master flat<a class="headerlink" href="#spectral-normalization-of-the-master-flat" title="Link to this heading">¶</a></h2>
<p>Before the light from the flat-field illumination source (such as a halogen lamp)
reaches the detector, it has to pass an array of optical elements
- such as dispersers and filters. These optical elements, and the detector itself,
have wavelength-dependent efficiencies. Because of the disperser,
photons with different wavelengths will hit the detector in different places,
meaning that these wavelength-dependent efficiencies will make the flat-field
non-uniform in the spectral direction, as sketched below:</p>
<a class="reference internal image-reference" href="_images/flat_example.png"><img alt="_images/flat_example.png" class="align-center" src="_images/flat_example.png" style="width: 100%;" />
</a>
<p>In this step, we want to normalize this spectral response, as we are only interested
in the pixel-to-pixel sensitivity of the detector when flat-fielding.</p>
<p>Firstly, a slice-spectrum is taken from the median flat in the spectral direction.
This is analogous as the arc lamp 1d spectrum extraction in the <a class="reference internal" href="wavecalib.html#wavecalib"><span class="std std-ref">wavelength calibration</span></a>. The <code class="docutils literal notranslate"><span class="pre">&quot;offset_middle_cut&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;pixel_cut_extension&quot;</span></code> from the wacecalibration
parameters can be used to adjust the shape and position of the slice-spectrum
(see <a class="reference internal" href="wavecalib.html#line-reidentification"><span class="std std-ref">the documentation for line reidentification</span></a>).
Further, you will have the option to manually crop away any noisy edges that
would corrupt later fitting (in the example below from the SDSS_J213510+2728
tutorial data, this would bbe the overscan region with zero counts):</p>
<a class="reference internal image-reference" href="_images/flat_adjust.png"><img alt="_images/flat_adjust.png" class="align-center" src="_images/flat_adjust.png" style="width: 100%;" />
</a>
<p>A B-Spline is then fitted to the slice-spectrum (wavelength vs. counts) to
estimate the spectral response of the detector:</p>
<a class="reference internal image-reference" href="_images/spectral_response_fit.png"><img alt="_images/spectral_response_fit.png" class="align-center" src="_images/spectral_response_fit.png" style="width: 100%;" />
</a>
<p>Here, the main thing to watch out for is <strong>overfitting</strong>. The B-Spline should
be a smooth representation of the spectral response, and should not be
overfitting to the level of pixel-to-pixel deviations. The following parameters
can be adjusted to control the fitting, with example values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;knots_spectral_bspline&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="c1"># number of bspline knots</span>
    <span class="s2">&quot;degree_spectral_bspline&quot;</span><span class="p">:</span> <span class="mi">3</span> <span class="c1"># degree of the bspline</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The fitted 1d spectral response model is then evaluated at each pixel on the
detector in order to construct a 2d spectral response model. The median flat
is then divided by this 2d spectral response model to produce the spectrally
normalized master flat.</p>
</section>
<section id="optional-spatial-normalization-of-the-master-flat">
<h2>(Optional) Spatial normalization of the master flat<a class="headerlink" href="#optional-spatial-normalization-of-the-master-flat" title="Link to this heading">¶</a></h2>
<p>The same way that the flat-field is non-uniform in the spectral direction,
so might it be in the spatial direction, if the illumination source is not
uniform in the spatial direction. In this case, you can also normalize the
master flat in the spatial direction. This is done by setting the parameter
<code class="docutils literal notranslate"><span class="pre">&quot;skip_spacial&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> in the configuration file. Whether it is necessary/suitable
to do is <a class="reference internal" href="#spacial-normalization"><span class="std std-ref">discussed below</span></a>.</p>
<p>The spatial normalization procedure is very similar to the spectral normalization.
Firstly, a slice-spectrum is taken from the median flat in the spatial direction,
and you can crop away any noisy edges. In the case for the tutorial data GQ1218+0832,
the edges with no signal should be cropped away:</p>
<a class="reference internal image-reference" href="_images/spacial_crop.png"><img alt="_images/spacial_crop.png" class="align-center" src="_images/spacial_crop.png" style="width: 100%;" />
</a>
<p>The gap in the middle of the GTC Osiris detector mosaic is also unwanted, but
the software does some sigma-clipping to remove outliers, so the fits should
be fine if your own data has similar artifacts.</p>
<p>A B-Spline is then fitted to every spacial column of the detector, and a
sample is taken for quality assesment:</p>
<a class="reference internal image-reference" href="_images/spacial_fit_example.png"><img alt="_images/spacial_fit_example.png" class="align-center" src="_images/spacial_fit_example.png" style="width: 100%;" />
</a>
<p id="spacial-normalization">As with the spectral normalization, the main thing to watch out for is <strong>overfitting</strong>.
The B-Spline should be a smooth representation of the spatial response, and should not be
overfitting to the level of pixel-to-pixel deviations. Furthermore, since there are
many fits, they are rejected/accepted automatically based on a user-defined
<span class="math notranslate nohighlight">\(R^2\)</span> threshold (ex. the first fit in the above figure is automatically rejected).
The following parameters can be adjusted to control the fitting
(with example values):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;flat&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;knots_spacial_bspline&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="c1"># number of bspline knots</span>
    <span class="s2">&quot;degree_spacial_bspline&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1"># degree of the bspline</span>
    <span class="s2">&quot;R2_spacial_bspline&quot;</span><span class="p">:</span> <span class="mf">0.4</span> <span class="c1"># R^2 threshold for the fits</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From experience, the <span class="math notranslate nohighlight">\(R^2\)</span> threshold might be needed to set relatively low,
as the fits can be quite noisy.</p>
<p>The spacial model is constructed as a stack of the individual 1d fits. For the
fits that failed, the model is interpolated from the nearest successful fits.
The amount of failed fits is plotted on the detector for quality assesment.</p>
<p>As  shown with the example dataset SDSS_J213510+2728, it is okay so see some failed fits
scattered around the detector and in the edges, but you should revise the
parameters if large areas (that are not detector edges) fail:</p>
<a class="reference internal image-reference" href="_images/failed_spatial_fits.png"><img alt="_images/failed_spatial_fits.png" class="align-center" src="_images/failed_spatial_fits.png" style="width: 100%;" />
</a>
</section>
<section id="final-quality-assesment-plot">
<h2>Final Quality Assesment Plot<a class="headerlink" href="#final-quality-assesment-plot" title="Link to this heading">¶</a></h2>
<p>Upon exiting, the software will produce a plot that shows the master flat
and a histogram of the pixel values through each stage of the flat-fielding:</p>
<a class="reference internal image-reference" href="_images/flat_final.png"><img alt="_images/flat_final.png" class="align-center" src="_images/flat_final.png" style="width: 100%;" />
</a>
<p>The final master flat should be mostly uniform, with a approximetly
Gaussian distribution of pixel values. Non uniformities in the flat-field
are usually caused by dust on the optics, and not only is it okay if you see
them in the master flat, it is exactly what you are looking for - as these
will now get normalized when dividing the observations with the master flat:</p>
<a class="reference internal image-reference" href="_images/dust.png"><img alt="_images/dust.png" class="align-center" src="_images/dust.png" style="width: 50%;" />
</a>
<p>The stripes seen in the SDSS_J213510+2728 tutorial data are inherited from the raw
frames and are not caused by the flat-fielding procedure:</p>
<a class="reference internal image-reference" href="_images/fringes.png"><img alt="_images/fringes.png" class="align-center" src="_images/fringes.png" style="width: 50%;" />
</a>
<p>There are ways to remove these stripes (fringing), but they are not implemented
in the software in order to keep the pipeline simple. The pictures above are
agressively normalized to show the stripes - they are not as prominent as they
appear in the pictures.</p>
</section>
<section id="considerations-on-spatial-normalization">
<h2>Considerations on spatial normalization<a class="headerlink" href="#considerations-on-spatial-normalization" title="Link to this heading">¶</a></h2>
<p>The normalization in spacial direction is performed under the assumption that
the uneven spacial illumination of the detector flat-field is caused by the flat-field
source itself being uneven through the length of the slit. This infers another
assumption that the uneven spatial illumination is not caused by the optical
system itself - and that the light of the science object can be assumed
to have the same intensity (on the large scale), regardless of where the object
is placed on the slit. This assumption might be not valid for some instruments.
You can try to do a reduction run with spacial normalization, and if you start
seeing strange artifacts in the reduced science frames, you can try to do the
reduction without spacial normalization.</p>
</section>
<section id="for-users-new-to-data-reduction-short-introduction-to-falt-fielding">
<h2>For users new to data reduction - short introduction to falt-fielding<a class="headerlink" href="#for-users-new-to-data-reduction-short-introduction-to-falt-fielding" title="Link to this heading">¶</a></h2>
<p>Since the number of pixels on a detector is in the order of millions, it is necessary to assume homogeneous pixel
sensitivity throughout the detector in order to make any further computations feasible. In other words, we want to
assume that any registered photon on the detector will be registered with the same efficiency regardless of what pixel
registers it. The physical properties of CCD detectors do not verify this assumption, but this can be reached
through calibration.</p>
<p>Theoretically, the flat-field calibration procedure requires exposing the detector with completely uniform light throughout
the detector. Since every pixel receives the same amount of light, any differences in registered counts between pixels
can be used to evaluate the difference in pixel-to-pixel sensitivity. This kind of exposure of uniform light is called a
flat-field. In practise, the procedure for flat-fielding the detector while performing spectroscopy is more complicated.
From personal experience, the flat-fielding procedure is the most contraversial step in spectroscopic data reduction, as
the idealogical assummption of uniform illumination is practically impossible to achieve.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyLongslit</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="getting_started.html">Getting started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting_started.html#downloading-the-tutorial-data">Downloading the tutorial data</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="getting_started.html#tutorial">Tutorial</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="general_notes.html">General Notes on using the pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration_file.html">Configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="bias.html">Bias</a></li>
<li class="toctree-l3"><a class="reference internal" href="dark_current.html">Dark current subtraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="combine_arcs.html">Combinning arc frames</a></li>
<li class="toctree-l3"><a class="reference internal" href="identify.html">Identify arc lines</a></li>
<li class="toctree-l3"><a class="reference internal" href="wavecalib.html">Wavelength Calibration</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Flat-field</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#quickstart">Quickstart</a></li>
<li class="toctree-l4"><a class="reference internal" href="#median-combination-of-the-raw-flat-frames">Median combination of the raw flat frames</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spectral-normalization-of-the-master-flat">Spectral normalization of the master flat</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-spatial-normalization-of-the-master-flat">(Optional) Spatial normalization of the master flat</a></li>
<li class="toctree-l4"><a class="reference internal" href="#final-quality-assesment-plot">Final Quality Assesment Plot</a></li>
<li class="toctree-l4"><a class="reference internal" href="#considerations-on-spatial-normalization">Considerations on spatial normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#for-users-new-to-data-reduction-short-introduction-to-falt-fielding">For users new to data reduction - short introduction to falt-fielding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="reduce.html">Reduction of observations</a></li>
<li class="toctree-l3"><a class="reference internal" href="crr.html">Cosmic ray removal</a></li>
<li class="toctree-l3"><a class="reference internal" href="AB.html">A-B Background subtraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="crop.html">Cropping of images</a></li>
<li class="toctree-l3"><a class="reference internal" href="sky.html">Modelled sky subtraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="show_2dspec.html">2D Spectrum Viewer</a></li>
<li class="toctree-l3"><a class="reference internal" href="objtrace.html">Object Tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="extract_1d.html">Extracting 1D spectrum</a></li>
<li class="toctree-l3"><a class="reference internal" href="sensfunction.html">Sensitivity function</a></li>
<li class="toctree-l3"><a class="reference internal" href="calibrate.html">Flux calibration</a></li>
<li class="toctree-l3"><a class="reference internal" href="combine_spec.html">Combining the spectra</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="uncertainties.html">Note on how the software estimates uncertainties</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="getting_started.html">Getting started</a><ul>
      <li>Previous: <a href="wavecalib.html" title="previous chapter">Wavelength Calibration</a></li>
      <li>Next: <a href="reduce.html" title="next chapter">Reduction of observations</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/flat.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>